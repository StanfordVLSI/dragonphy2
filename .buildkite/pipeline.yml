steps:
  - command: |
      # set up environment
      source /cad/modules/tcl/init/bash
      module load base xcelium

      # create virtual environment
      /usr/local/miniconda/bin/python3.7 -m venv venv
      source venv/bin/activate

      # upgrade pip
      pip install -U pip

      # install dragonphy
      pip install -e .

      # build models (TODO: cleanup)
      python vlog/fpga_models/gen_rx_adc_core.py -o vlog/fpga_models/

      # install pytest
      pip install pytest

      # run tests
      pytest tests -s -v -r s

      # simulate FPGA design
      anasymod -i tests/test_emu --sim --simulator_name xrun

      # deactivate virtual environment
      deactivate
    label: "test"
    timeout_in_minutes: 60
    agents:
      fault2: "true"
  - command: |
      # set up environment
      source /etc/environment
      echo $$PATH

      # create virtual environment
      python3.7 -m venv venv
      source venv/bin/activate

      # upgrade pip
      pip install -U pip

      # install dragonphy
      pip install -e .

      # build models (TODO: cleanup)
      python vlog/fpga_models/gen_rx_adc_core.py -o vlog/fpga_models/

      # install pytest
      pip install pytest

      # build file structure
      pytest tests/test_emu/test_emu_build.py -s -v -r s

      # simulate FPGA design
      anasymod -i tests/test_emu --sim --simulator_name vivado

      # build bitstream
      anasymod -i tests/test_emu --build

      # show results of bitstream build
      tree tests/test_emu
      cat tests/test_emu/build/fpga/project/project.runs/synth_1/runme.log
      cat tests/test_emu/build/fpga/project/project.runs/impl_1/runme.log

      # program FPGA and run test
      export FPGA_SERVER=1
      pytest tests/test_emu/test_emu_prog.py -s -v -r s

      # deactivate virtual env
      deactivate
    label: "test_emu"
    timeout_in_minutes: 60
    agents:
        fpga_verif: "true"
